# Config file dedicated to the user's personal zshrc profile shared between all exegol containers.
# This file is sourced in /root/.zshrc file.
# Alternatively, the /opt/my-resources/setup/load_user_setup.sh file can be used to operate the change once (instead of sourcing a file for each zsh instance)

# Disable Exegol's prompt hook so Starship can take over
add-zsh-hook -d precmd update_prompt

# Add custom tools to PATH
export PATH="/opt/my-resources/bin:$PATH"

# Copy starship config if not present
if [ ! -f ~/.config/starship.toml ] && [ -f /opt/my-resources/setup/starship/starship.toml ]; then
    mkdir -p ~/.config
    cp /opt/my-resources/setup/starship/starship.toml ~/.config/starship.toml
fi

# Initialize Starship prompt
if command -v /opt/my-resources/bin/starship &> /dev/null; then
    eval "$(/opt/my-resources/bin/starship init zsh)"
fi

# Initialize zoxide (better cd)
if command -v /opt/my-resources/bin/zoxide &> /dev/null; then
    eval "$(/opt/my-resources/bin/zoxide init zsh)"
fi

# eza aliases (better ls)
alias ls='/opt/my-resources/bin/eza --icons=always --group-directories-first'
alias ll='/opt/my-resources/bin/eza --icons=always --group-directories-first -l'
alias la='/opt/my-resources/bin/eza --icons=always --group-directories-first -la'
alias lt='/opt/my-resources/bin/eza --icons=always --group-directories-first --tree'
alias l='/opt/my-resources/bin/eza --icons=always --group-directories-first -F'

# bat aliases (better cat)
alias cat='/opt/my-resources/bin/bat --style=plain --paging=never'
alias catp='/opt/my-resources/bin/bat --style=full'

# fd alias (better find)
alias fd='/opt/my-resources/bin/fd'

# delta (better git diff)
alias diff='/opt/my-resources/bin/delta'

# zellij config and alias - always sync from my-resources
if [ -d /opt/my-resources/setup/zellij ]; then
    mkdir -p ~/.config
    rm -rf ~/.config/zellij
    cp -r /opt/my-resources/setup/zellij ~/.config/zellij
fi
alias zj='/opt/my-resources/bin/zellij'

# Burp Suite Pro - restore config and alias
if [ -d /opt/my-resources/setup/burp-config/burp ] && [ ! -d /root/.java/.userPrefs/burp ]; then
    mkdir -p /root/.java/.userPrefs
    cp -r /opt/my-resources/setup/burp-config/burp /root/.java/.userPrefs/burp
fi
alias burppro='/opt/my-resources/bin/BurpSuitePro/BurpSuitePro &> /dev/null &'

# ZSH History sharing (for Zellij panes/tabs)
HISTFILE=~/.zsh_history
HISTSIZE=50000
SAVEHIST=50000
setopt SHARE_HISTORY
setopt INC_APPEND_HISTORY
setopt HIST_IGNORE_ALL_DUPS
setopt HIST_FIND_NO_DUPS
setopt HIST_REDUCE_BLANKS

# Force history sync before each prompt
precmd_functions+=(_sync_history)
_sync_history() {
    fc -R
}

# Ctrl+H to manually sync history from other panes
sync-history-widget() {
    fc -R
    zle reset-prompt
    zle -M "History synced"
}
zle -N sync-history-widget
bindkey '^H' sync-history-widget

# Sliver persistence - sync both ways
SLIVER_BACKUP="/opt/my-resources/setup/sliver"

# Restore sliver configs on shell start (only if backup exists and local doesn't)
if [ -d "$SLIVER_BACKUP/.sliver" ] && [ ! -d /root/.sliver ]; then
    cp -r "$SLIVER_BACKUP/.sliver" /root/.sliver
fi
if [ -d "$SLIVER_BACKUP/.sliver-client" ] && [ ! -d /root/.sliver-client ]; then
    cp -r "$SLIVER_BACKUP/.sliver-client" /root/.sliver-client
fi

# Auto-backup sliver configs on shell exit
_backup_sliver() {
    if [ -d /root/.sliver ] || [ -d /root/.sliver-client ]; then
        mkdir -p "$SLIVER_BACKUP"
        [ -d /root/.sliver ] && rsync -a --delete /root/.sliver/ "$SLIVER_BACKUP/.sliver/"
        [ -d /root/.sliver-client ] && rsync -a --delete /root/.sliver-client/ "$SLIVER_BACKUP/.sliver-client/"
    fi
}
add-zsh-hook zshexit _backup_sliver
